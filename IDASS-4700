@ExtendWith(MockitoExtension.class)
class LegacyCredentialProxyServiceTest {

    @Mock
    private LbgRestTemplate lbgRestTemplate;

    @Mock
    private CapiLegacyProperties capiLegacyProperties;

    @Mock
    private CapiLegacyProperties.Operations operations;

    @Mock
    private ErrorUtil errorUtil;

    @Spy
    @InjectMocks
    private LegacyCredentialProxyService legacyCredentialProxyService;

    private Map<String, String> headerMap;

    private static final String BASE_URL = "http://mock-cap1";
    private static final String ENDPOINT = "/credentials/{credentialStore}/{partition}";

    @BeforeEach
    void init() {
        MockitoAnnotations.openMocks(this);  // ðŸ”¥ VERY IMPORTANT
        headerMap = new HashMap<>();
        headerMap.put("x-lbg-session-id", "sess");
        headerMap.put("x-lbg-txn-correlation-id", "cor");
        headerMap.put("x-lbg-brand", "SCW");

        // Mock property chain
        when(capiLegacyProperties.getBaseUrl()).thenReturn(BASE_URL);
        when(capiLegacyProperties.getOperations()).thenReturn(operations);
        when(operations.getCredentialEndpoint()).thenReturn(ENDPOINT);
        when(operations.getStore()).thenReturn("ida");
        when(operations.getPartition()).thenReturn("PI_SCW");

        // Mock buildUrl() override
        doReturn("http://mock-url")
                .when(legacyCredentialProxyService)
                .buildUrl(anyString(), anyString());
    }

    @Test
    void testGetLegacyCredential_Success() {

        String linkedCustomerId = "cust123";
        String userName = "john";

        LegacyCredentialResponse mockResponse = new LegacyCredentialResponse();

        when(lbgRestTemplate.executeGetRequest(
                eq("http://mock-url"),
                any(HttpEntity.class),
                eq(LegacyCredentialResponse.class),
                eq(linkedCustomerId),
                eq(userName)
        )).thenReturn(mockResponse);

        // Call service
        LegacyCredentialResponse result = legacyCredentialProxyService
                .getLegacyCredential(headerMap, linkedCustomerId, userName);

        assertNotNull(result);
        assertEquals(mockResponse, result);
    }
}

-------------------------------
package com.lbg.iau.ssi.coordinator.identity.resolver.service;

import com.lbg.iau.ssi.coordinator.common.LbgRestTemplate;
import com.lbg.iau.ssi.coordinator.identity.resolver.model.LegacyCredentialResponse;
import com.lbg.iau.ssi.coordinator.identity.resolver.properties.CapiLegacyProperties;
import com.lbg.iau.ssi.coordinator.identity.resolver.util.ErrorUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.test.util.ReflectionTestUtils;

import java.util.HashMap;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.when;
import static org.mockito.Mockito.doReturn;

@ExtendWith(MockitoExtension.class)
class LegacyCredentialProxyServiceTest {

    @Mock private LbgRestTemplate lbgRestTemplate;
    @Mock private CapiLegacyProperties capiLegacyProperties;
    @Mock private CapiLegacyProperties.Operations operations;
    @Mock private ErrorUtil errorUtil;

    @InjectMocks
    private LegacyCredentialProxyService legacyCredentialProxyService;

    Map<String, String> headerMap;

    private static final String BASE_URL = "http://mock-capi";
    private static final String ENDPOINT = "/credentials/{credentialStore}/{partition}";

    @BeforeEach
    void setUp() {
        headerMap = new HashMap<>();
        headerMap.put("x-lbg-session-id", "sess");
        headerMap.put("x-lbg-txn-correlation-id", "corr");
        headerMap.put("x-lbg-brand", "SCW");

        // Mock properties
        when(capiLegacyProperties.getBaseUrl()).thenReturn(BASE_URL);
        when(capiLegacyProperties.getOperations()).thenReturn(operations);
        when(operations.getCredentialEndpoint()).thenReturn(ENDPOINT);
        when(operations.getStore()).thenReturn("ida");
        when(operations.getPartition()).thenReturn("PI_SCW");

        // Allow buildUrl override
        doReturn("http://mock-url").when(legacyCredentialProxyService)
                .buildUrl(anyString(), anyString());
    }

    @Test
    void testGetLegacyCredential_Success() {

        String linkedCustomerId = "cust123";
        String userName = "john";

        LegacyCredentialResponse mockResponse = new LegacyCredentialResponse();
        ResponseEntity<LegacyCredentialResponse> responseEntity =
                new ResponseEntity<>(mockResponse, HttpStatus.OK);

        when(lbgRestTemplate.executeGetRequest(
                eq("http://mock-url"),
                any(HttpEntity.class),
                eq(LegacyCredentialResponse.class),
                eq(linkedCustomerId),
                eq(userName)
        )).thenReturn(mockResponse);

        LegacyCredentialResponse result = legacyCredentialProxyService
                .getLegacyCredential(headerMap, linkedCustomerId, userName);

        assertNotNull(result);
        assertEquals(mockResponse, result);
    }

    @Test
    void testGetLegacyCredential_Exception() {

        String linkedCustomerId = "cust123";
        String userName = "john";

        when(lbgRestTemplate.executeGetRequest(
                anyString(),
                any(HttpEntity.class),
                eq(LegacyCredentialResponse.class),
                anyString(),
                anyString()
        )).thenThrow(new RuntimeException("CAPI Failure"));

        when(errorUtil.buildCoordinatorException(any(), any()))
                .thenReturn(new RuntimeException("Converted"));

        assertThrows(RuntimeException.class, () ->
                legacyCredentialProxyService.getLegacyCredential(
                        headerMap, linkedCustomerId, userName));
    }
}


--------------------------------------------------------------------------
LegacyCredentialProxyService

package com.lbg.iau.ssi.coordinator.identity.resolver.service;

import com.lbg.iau.ssi.coordinator.identity.resolver.config.CapiLegacyProperties;
import com.lbg.iau.ssi.coordinator.identity.resolver.model.LegacyCredentialResponse;
import com.lbg.iau.ssi.common.logging.ApplicationLogger;
import com.lbg.iau.ssi.common.logging.LoggerManager;
import com.lbg.iau.ssi.common.rest.LbgRestTemplate;
import com.lbg.iau.ssi.common.util.ErrorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.util.UriComponentsBuilder;

import java.util.Map;
import java.util.UUID;

@Service
public class LegacyCredentialProxyService {

    private static final ApplicationLogger LOGGER =
            LoggerManager.getApplicationLogger(LegacyCredentialProxyService.class);

    @Autowired
    private LbgRestTemplate lbgRestTemplate;

    @Autowired
    private CapiLegacyProperties capiLegacyProperties;

    @Autowired
    private ErrorUtil errorUtil;


    /**
     * SDID-style method to call Legacy Consumable API
     */
    public LegacyCredentialResponse getLegacyCredential(
            Map<String, String> headerMap,
            String linkedCustomerId,
            String userName) {

        LOGGER.info(headerMap, () -> "Calling Legacy Credential CAPI");

        // Build Headers (SDID style)
        HttpEntity<?> requestEntity = new HttpEntity<>(buildHeaders(headerMap));

        // Build URL (SDID style)
        String url = buildUrl(linkedCustomerId, userName);

        LOGGER.debug(headerMap, () -> "Constructed Legacy Credential URL: " + url);

        try {
            return lbgRestTemplate.executeGet(
                    url,
                    requestEntity,
                    LegacyCredentialResponse.class,
                    linkedCustomerId,
                    userName
            );

        } catch (Exception ex) {
            LOGGER.error(headerMap, () -> "Error calling Legacy Credential CAPI", ex);
            throw errorUtil.toDownstreamError(ex);
        }
    }



    /**
     * Build headers like SDID buildCapiHeaders()
     */
    private HttpHeaders buildHeaders(Map<String, String> headerMap) {
        HttpHeaders headers = new HttpHeaders();
        headers.setAll(headerMap);
        headers.set("x-lbg-session-id", UUID.randomUUID().toString());
        headers.set("x-lbg-txn-correlation-id", UUID.randomUUID().toString());
        headers.setContentType(MediaType.APPLICATION_JSON);
        return headers;
    }


    /**
     * Build URL in SDID style using UriComponentsBuilder
     */
    private String buildUrl(String linkedCustomerId, String userName) {

        return UriComponentsBuilder.fromHttpUrl(capiLegacyProperties.getBaseUrl())
                .path(capiLegacyProperties.getCredentialsEndpoint())
                .path("/")
                .path(capiLegacyProperties.getStore())
                .path("/")
                .path(capiLegacyProperties.getPartition())
                .queryParam("linkedCustomerId", linkedCustomerId)
                .queryParam("userName", userName)
                .toUriString();
    }

}


-------------------------------------------------------------------------------------------------------------------
public LegacyCredentialResponse getLegacyCredential(String linkedCustomerId, String userName) {

    try {

        // Build URL:  https://localhost:8080/iau-legacy-identity-consumable-api/v1/credentials/{store}/{partition}
        String url = UriComponentsBuilder
                .fromUriString(capiLegacyProperties.getBaseUrl())
                .path("/credentials/")
                .path(capiLegacyProperties.getCredentialStore())
                .path("/")
                .path(capiLegacyProperties.getPartition())
                .queryParam("linkedCustomerId", linkedCustomerId)
                .queryParam("userName", userName)
                .build()
                .toString();

        // Prepare headers
        HttpHeaders headers = new HttpHeaders();
        headers.add("x-lbg-session-id", UUID.randomUUID().toString());
        headers.add("x-lbg-txn-correlation-id", UUID.randomUUID().toString());
        headers.add("x-lbg-brand", "SCW");
        headers.setContentType(MediaType.APPLICATION_JSON);

        HttpEntity<Void> entity = new HttpEntity<>(headers);

        // Call downstream
        LOGGER.info("Calling Legacy Consumable API: {}", url);

        ResponseEntity<LegacyCredentialResponse> response =
                lbgRestTemplate.exchange(
                        url,
                        HttpMethod.GET,
                        entity,
                        LegacyCredentialResponse.class
                );

        return response.getBody();

    } catch (HttpStatusCodeException ex) {
        LOGGER.error("Downstream error: {}", ex.getResponseBodyAsString());
        throw errorUtil.toDownstreamError(ex);
    } catch (Exception ex) {
        LOGGER.error("Unknown error calling legacy API", ex);
        throw errorUtil.toGenericError(ex);
    }
}


------------------------------------------
1. Write the full mock method

public Expectation[] legacyCredentials() {
    return new Expectation[] {
        new Expectation(
            request()
                .withMethod("GET")
                .withPath("/iau-legacy-identity-consumable-api/v1/credentials/ida/PI_SCW")
                .withQueryStringParameter("linkedCustomerId", "2745...1748")
                .withQueryStringParameter("userName", "barry@emaildomain.com")
        ).thenRespond(
            response()
                .withStatusCode(200)
                .withHeader("Content-Type", "application/json")
                .withBody(readFileFromClassPathOrPath("expectations/legacy-credentials.json"))
        )
    };
}
------------------------
2. Add the JSON response file

src/test/resources/expectations/legacy-credentials.json

{
  "credentialId": "123e4567-e89b-12d3-a456-426614174000",
  "linkedCustomerId": "27458002-02c2-4571-9041-6b518a241748",
  "userName": "barry@emaildomain.com",
  "status": "ACTIVE",
  "passwordStatus": "A",
  "isMfaSet": true,
  "group": ["BLH", "JAG", "HAL", "LDR", "IB", "BOS", "SZX", "SCW"],
  "accountCreationDate": "2024-01-11T13:26:41.253Z",
  "lastStatusChangeDate": "2024-01-11T13:26:41.253Z",
  "lastPasswordChangeDate": "2024-01-11T13:26:41.253Z",
  "lastLoggedInTime": "2024-01-11T13:26:41.253Z",
  "passwordExpiryDate": "2024-01-11T13:26:41.253Z",
  "currentGlobalCounter": 0
}
---------------------------------------------
3. Register the new mock inside initializeExpectations()

return Stream.of(
    credentials(), cache(), customers(), session(),
    card_reader(), mi(), sdid(),
    legacyCredentials()     // ðŸ‘‰ ADD THIS
)
----------------------------------------------------------------------
4. Verify the path matches Swagger exactly

GET /credentials/{credentialStore}/{partition}
For your test case:

credentialStore â†’ ida

partition â†’ PI_SCW

So final path:
/iau-legacy-identity-consumable-api/v1/credentials/ida/PI_SCW
------------------------------------------------------------------------------------
5. Start MockServer and test the URL manually

http://localhost:1080/iau-legacy-identity-consumable-api/v1/credentials/ida/PI_SCW?linkedCustomerId=2745...1748&userName=barry@emaildomain.com

